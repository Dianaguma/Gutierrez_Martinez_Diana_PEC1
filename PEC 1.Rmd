---
title: "PEC 1 Diana_Gutiérrez"
author: "Diana Gutierrez Martínez"
date: "2025-03-26"
---

```{r}
# Configura un mirror de CRAN (ejemplo con el mirror de RStudio)
options(repos = c(CRAN = "https://cran.rstudio.com"))

# Instalar paquetes
install.packages("usethis")
install.packages("BiocManager")

install.packages("usethis")
library(usethis)

# Configurar GitHub remoto (opcional, solo si es necesario para tu proyecto)
use_git_remote(url = "https://github.com/Dianaguma/Gutierrez_Mart-nez-_Diana_PEC1", overwrite = TRUE)

# Seleccionar un mirror de CRAN
chooseCRANmirror(graphics = FALSE, ind = 1)

# Instalar y cargar BiocManager para paquetes de Bioconductor
install.packages("BiocManager")
BiocManager::install("SummarizedExperiment")

# Instalar y cargar readr para manejo de archivos CSV
install.packages("readr")
library(SummarizedExperiment)
library(readr)

# Leer el archivo CSV con la ruta completa
data <- read.csv("C:/Users/merma/OneDrive/Escritorio/MASTER BIOINFORMATICA/analisis de datos omicos/Gutiérrez -Martínez -Diana-PEC1/human_cachexia.csv")

# Separar los metadatos (por ejemplo, Patient ID y Muscle loss)
sample_data <- data[, c("Patient.ID", "Muscle.loss")]

View(data)

# Convertir "Muscle_loss" en factor
sample_data$Muscle.loss <- factor(sample_data$Muscle.loss)

# Eliminar filas con NA en los metadatos
sample_data <- sample_data[complete.cases(sample_data), ]

# Separar los datos experimentales (mediciones de metabolitos)
exp_data <- data[, -(1:2)]  # Eliminamos las primeras dos columnas (metadatos)

# Convertir los datos experimentales a matriz
data_matrix <- as.matrix(exp_data)

print(data_matrix)

# matriz o conjunto de datos que lista varios metabolitos o compuestos bioquímicos junto con sus concentraciones correspondientes. Cada fila representa una muestra, y cada columna corresponde a un metabolito diferente. Los valores en la tabla representan los niveles de concentración de cada metabolito en cada muestra. El conjunto de datos parece contener muchos metabolitos involucrados en diferentes vías metabólicas, como aminoácidos, ácidos orgánicos y otros compuestos bioquímicos. Estos compuestos pueden ser importantes para estudios relacionados con el metabolismo, la bioquímica o cualquier área donde el perfil metabólico sea relevante.

# Verificar que los nombres de fila están vacíos o incorrectos
if (is.null(rownames(data_matrix)) || length(rownames(data_matrix)) == 0) {
  cat("Asignando los nombres de fila a data_matrix...\n")
  
  # Comprobamos que los IDs en sample_data coinciden con las filas de data_matrix
  if (length(sample_data$Patient.ID) == nrow(data_matrix)) {
    rownames(data_matrix) <- sample_data$Patient.ID
  } else {
    stop("El número de filas en sample_data no coincide con el número de filas en data_matrix.")
  }
}

# Verificar los nombres de las filas
cat("Comprobando los nombres de fila...\n")
print(head(rownames(data_matrix)))  # Muestra los primeros nombres de fila

# > print(head(rownames(data_matrix)))  # Muestra los primeros nombres de fila[1] "PIF_178"     "PIF_087"     "PIF_090"     "NETL_005_V1" "PIF_115"     "PIF_110"  



# Verificar si hay duplicados en Patient.ID y eliminarlos
sample_data <- sample_data[!duplicated(sample_data$Patient.ID), ]
data_matrix <- data_matrix[!duplicated(rownames(data_matrix)), ]

# Asegurar que solo se mantienen IDs comunes entre sample_data y data_matrix
common_ids <- intersect(sample_data$Patient.ID, rownames(data_matrix))

# Filtrar ambas estructuras para mantener solo las IDs en común
sample_data <- sample_data[sample_data$Patient.ID %in% common_ids, ]
data_matrix <- data_matrix[rownames(data_matrix) %in% common_ids, ]

# Asegurar que las filas en data_matrix y sample_data están alineadas
cat("Alineando filas de data_matrix y sample_data...\n")

# Usamos match para encontrar las filas en el orden correcto
order_indices <- match(sample_data$Patient.ID, rownames(data_matrix))

# Verificar si todos los IDs de sample_data están presentes en rownames(data_matrix)
if (any(is.na(order_indices))) {
  cat("Advertencia: Algunos Patient.ID de sample_data no están presentes en rownames(data_matrix).\n")
}

# Reordenar ambas estructuras según el índice obtenido con match
data_matrix <- data_matrix[order_indices, ]
sample_data <- sample_data[order_indices, ]

# Verificar nuevamente las dimensiones

cat("Dimensiones de sample_data:", dim(sample_data), "\n")
cat("Dimensiones de data_matrix:", dim(data_matrix), "\n")

nrow(data_matrix)  # Debería coincidir con el número de Patient.ID #77
length(sample_data$Patient.ID)  # 77

sample_data <- sample_data[!duplicated(sample_data$Patient.ID), ]
data_matrix <- data_matrix[!duplicated(rownames(data_matrix)), ]

common_ids <- intersect(sample_data$Patient.ID, rownames(data_matrix))

sample_data <- sample_data[sample_data$Patient.ID %in% common_ids, ]
data_matrix <- data_matrix[rownames(data_matrix) %in% common_ids, ]

order_indices <- match(sample_data$Patient.ID, rownames(data_matrix))

data_matrix <- data_matrix[order_indices, ]
sample_data <- sample_data[order_indices, ]


# Crear el objeto SummarizedExperiment
se <- SummarizedExperiment(
  assays = list(counts = data_matrix),
  colData = sample_data
)

# Ver el objeto SummarizedExperiment
se


# Resultado al mostrar el summarizedExperiment: 
# class: SummarizedExperiment 
#dim: 63 63 
#metadata(0):
#assays(1): counts
#rownames(63): PIF_178 PIF_087 ... NETCR_008_V1 NETCR_008_V2
#rowData names(1): MuscleLoss
#colnames(63): 1,6-Anhydro-beta-D-glucose 1-Methylnicotinamide ...
#  pi-Methylhistidine tau-Methylhistidine
#colData names(2): Patient ID Muscle loss

save(se, file = "C:/Users/merma/OneDrive/Escritorio/MASTER BIOINFORMATICA/analisis de datos omicos/Gutiérrez -Martínez -Diana-PEC1/SummarizedExperiment_Diana_Gutiérrez.rda")

# Así agrego un archivo Rda que agregaré a github de los summarizedExperiment


# 3. Llevad a cabo un análisis exploratorio que os proporcione una visión general del dataset en la línea de lo que hemos visto en las actividades de este reto

colData(se)

colnames(assays(se)$counts) # nombres de los metabolitos (columnas de los ensayos):

se$`Muscle loss`

summary(assays(se)$counts) # puedo ver como actua los metabolitos. Me enfoco en el citrato y la creatinina que los veo muy elevados. Median del citrato:2079.74 . Median creatinine: 8350. 

apply(assays(se)$counts, 2, mean)  # Promedio de cada metabolito . Me enfoco en el citrato y la creatinina que los veo muy elevados. Median del citrato:2079.74 . Median creatinine: 8350. 

# Miro las desviaciones estandar por cada metabolito

sd_per_metabolite <- apply(assays(se)$counts, 2, sd)

print(sd_per_metabolite)

# El citrato tiene: 2317.814577  y la creatinina tiene: 297.054442

# Filtro datos de metabolitos con poca variabilidad 

metabolite_sd <- apply(assays(se)$counts, 2, sd)

se <- se[, metabolite_sd > 0.1]  # Mantén metabolitos con SD mayor a 0.1


# Vamos a hacer analisis gráficos 

install.packages("ggplot2")     # Para visualización
install.packages("dplyr")       # Para manipulación de datos
install.packages("patchwork")   # Para combinar gráficos
install.packages("GGally")      # Para análisis de correlación
install.packages("tidyr")

# Cargar las librerías necesarias

library(SummarizedExperiment)
library(reshape2)
library(ggplot2)

library(tidyr)

# Extraer los datos de los metabolitos del objeto SummarizedExperiment (se)
metabolite_data <- assay(se)  # Asegúrate de que 'se' es un objeto de clase SummarizedExperiment

# Calcular la matriz de correlación entre los metabolitos
cor_matrix <- cor(metabolite_data)

print(cor_matrix)

library(reshape2)
cor_data <- melt(cor_matrix)

# Crear el mapa de calor de la correlación entre metabolitos usando ggplot2
ggplot(cor_data, aes(Var1, Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1, 1), space = "Lab", 
                       name = "Correlación") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(title = "Mapa de calor de la correlación entre metabolitos",
       x = "Metabolito", 
       y = "Metabolito")


ggsave("C:/Users/merma/OneDrive/Escritorio/heatmap.png")

# PCA (Análisis de Componentes Principales) : Así hago exploración y visualizo la variabilidad de los datos:

pca_result <- prcomp(t(assays(se)$counts), scale = TRUE)
summary(pca_result)  # Resumen de las componentes principales

  
# PC1 tiene una sd  7.488

loadings <- pca_result$rotation

head(loadings)

# Las proyecciones de las muestras en cada componente principal (PC)
pca_scores <- pca_result$x

head(pca_scores)

# Convertir las proyecciones PCA a un data frame para la visualización
pca_scores_df <- data.frame(pca_scores)

# Graficar los primeros dos componentes principales (PC1 vs PC2)
library(ggplot2)
ggplot(pca_scores_df, aes(x = PC1, y = PC2)) +
  geom_point() +
  labs(title = "PCA: PC1 vs PC2", x = "PC1", y = "PC2") +
  theme_minimal()

directorio <- "C:/Users/merma/OneDrive/Escritorio/MASTER BIOINFORMATICA/analisis de datos omicos/Gutiérrez -Martínez -Diana-PEC1"

write.csv(pca_scores_df, file = paste0(directorio, "/pca_scores.csv")) 

# También lo adjunto al GitHub. 


# Extraer la proporción de varianza explicada

varianza_explicada <- pca_result$sdev^2 / sum(pca_result$sdev^2)

# Proporción acumulada de varianza
varianza_acumulada <- cumsum(varianza_explicada)

# Crear un data frame con la varianza explicada
varianza_df <- data.frame(PC = paste0("PC", 1:length(varianza_explicada)),
                          Varianza_Explicada = varianza_explicada,
                          Varianza_Acumulada = varianza_acumulada)

# Graficar varianza explicada y acumulada

library(ggplot2)

# Graficar varianza explicada y acumulada
ggplot(varianza_df, aes(x = PC)) +
  geom_bar(aes(y = Varianza_Explicada), stat = "identity", fill = "blue", alpha = 0.6) +
  geom_line(aes(y = Varianza_Acumulada * max(varianza_explicada), group = 1), color = "red", linewidth = 1) + 
  geom_point(aes(y = Varianza_Acumulada * max(varianza_explicada), group = 1), color = "red") + 
  labs(title = "Varianza Explicada y Acumulada por los Componentes Principales",
       x = "Componente Principal",
       y = "Proporción de Varianza / Acumulada") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_y_continuous(sec.axis = sec_axis(~./max(varianza_explicada), name = "Proporción Acumulada")) +
  theme_minimal()

ggsave("C:/Users/merma/OneDrive/Escritorio/varianza_explicada.png", width = 10, height = 6, dpi = 300)

```
![Heatmap](C:/Users/merma/OneDrive/Escritorio/heatmap.png) # Archivo agregado al proyecto GitHub
![Varianza explicada](C:/Users/merma/OneDrive/Escritorio/varianza_explicada.png) # Archivo agregado al proyecto GitHub
