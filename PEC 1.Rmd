---
title: "PEC 1 Diana_Gutiérrez"
author: "Diana Gutierrez Martínez"
date: "2025-03-26"
---


```{r}

# Configuración de un mirror de CRAN y paquetes necesarios
options(repos = c(CRAN = "https://cran.rstudio.com"))

# Instalar paquetes necesarios
install.packages(c("usethis", "BiocManager", "readr", "ggplot2", "dplyr", "patchwork", "GGally", "tidyr", "reshape2"))

# Cargar las librerías necesarias
library(usethis)
library(BiocManager)
library(SummarizedExperiment)
library(readr)
library(ggplot2)
library(dplyr)
library(patchwork)
library(GGally)
library(tidyr)
library(reshape2)

# Configuración de GitHub (solo si es necesario para tu proyecto)
use_git_remote(url = "https://github.com/Dianaguma/Gutierrez_Mart-nez-_Diana_PEC1", overwrite = TRUE)

# Leer los datos CSV desde la ruta especificada
data <- read.csv("C:/Users/merma/OneDrive/Escritorio/MASTER BIOINFORMATICA/analisis de datos omicos/Gutiérrez -Martínez -Diana-PEC1/human_cachexia.csv")

# Extraer los metadatos (Patient ID y Muscle loss)
sample_data <- data[, c("Patient.ID", "Muscle.loss")]

# Convertir "Muscle.loss" a factor
sample_data$Muscle.loss <- factor(sample_data$Muscle.loss)

# Eliminar filas con NA en los metadatos
sample_data <- sample_data[complete.cases(sample_data), ]

# Extraer los datos experimentales (metabolitos)
exp_data <- data[, -(1:2)]  # Eliminamos las dos primeras columnas (metadatos)

# Convertir los datos experimentales a una matriz
data_matrix <- as.matrix(exp_data)

# Verificar y asignar los nombres de las filas (Patient.ID)
if (is.null(rownames(data_matrix)) || length(rownames(data_matrix)) == 0) {
  if (length(sample_data$Patient.ID) == nrow(data_matrix)) {
    rownames(data_matrix) <- sample_data$Patient.ID
  } else {
    stop("El número de filas en sample_data no coincide con el número de filas en data_matrix.")
  }
}

# Eliminar duplicados en los metadatos y en las filas de la matriz
sample_data <- sample_data[!duplicated(sample_data$Patient.ID), ]
data_matrix <- data_matrix[!duplicated(rownames(data_matrix)), ]

# Asegurarse de que los IDs de las muestras coinciden entre sample_data y data_matrix
common_ids <- intersect(sample_data$Patient.ID, rownames(data_matrix))
sample_data <- sample_data[sample_data$Patient.ID %in% common_ids, ]
data_matrix <- data_matrix[rownames(data_matrix) %in% common_ids, ]

# Reordenar las filas para asegurarse de que están alineadas
order_indices <- match(sample_data$Patient.ID, rownames(data_matrix))
data_matrix <- data_matrix[order_indices, ]
sample_data <- sample_data[order_indices, ]

# Crear el objeto SummarizedExperiment
se <- SummarizedExperiment(
  assays = list(counts = data_matrix),
  colData = sample_data
)

# Guardar el objeto SummarizedExperiment
save(se, file = "C:/Users/merma/OneDrive/Escritorio/MASTER BIOINFORMATICA/analisis de datos omicos/Gutiérrez -Martínez -Diana-PEC1/SummarizedExperiment_Diana_Gutiérrez.rda")

# Análisis exploratorio de los datos
# Ver los metadatos
colData(se)

# Hacer un t.test

head(se)

muscle_loss <- colData(se)$Muscle.loss  # Esto debería estar alineado con las columnas de la matriz

# Separar los grupos 'control' y 'cachexic'
control_group <- assays(se)$counts[, muscle_loss == "control"]  # Filtro por columnas
case_group <- assays(se)$counts[, muscle_loss == "cachexic"]

sample_data <- sample_data[match(rownames(assays(se)$counts), sample_data$Patient.ID), ]

head(sample_data$Muscle.loss)

p_values <- apply(assays(se)$counts, 1, function(x) {
  t.test(x[sample_data$Muscle.loss == "control"], x[sample_data$Muscle.loss == "cachexic"])$p.value
})

head(p_values)

sorted_p_values <- sort(p_values)

print(sorted_p_values)

# Los p-valores son mayores que 0.05, no podemos rechazar la H0 (que afirma  que no hay diferencias entre los grupos). Por tanto, no encontramos evidencia suficiente para decir que los metabolitos analizados difieren significativamente entre los grupos de pacientes cachexicos y controles.

# Calcular y ver la media de cada metabolito

mean_values <- apply(assays(se)$counts, 2, mean)

sorted_mean_values_desc <- sort(mean_values, decreasing = TRUE)

head(sorted_mean_values_desc, 10)

# Respuesta: La Creatinine tiene el valor más alto de concentración entre los metabolitos estudiados, con 9521.7754, seguido por Hippurate (2614.1479) y Citrate (2423.4689). Esto sugiere que la creatinina podría ser uno de los metabolitos más presentes en las muestras que estás analizando.


# Calcular la desviación estándar por metabolito
sd_per_metabolite <- apply(assays(se)$counts, 2, sd)

# Puedo hacer un t-test

# Filtrar metabolitos con baja variabilidad (desviación estándar menor que 0.1)
metabolite_sd <- apply(assays(se)$counts, 2, sd)
se <- se[, metabolite_sd > 0.1]

# Mapa de calor de la correlación entre metabolitos
metabolite_data <- assay(se)  # Obtener los datos de los metabolitos
cor_matrix <- cor(metabolite_data)

# Convertir la matriz de correlación a formato largo para ggplot
cor_data <- melt(cor_matrix)

# Crear el mapa de calor usando ggplot2
ggplot(cor_data, aes(Var1, Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1, 1), space = "Lab", 
                       name = "Correlación") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(title = "Mapa de calor de la correlación entre metabolitos",
       x = "Metabolito", 
       y = "Metabolito")

# Guardar el mapa de calor como archivo PNG
ggsave("C:/Users/merma/OneDrive/Escritorio/heatmap.png")

# PCA (Análisis de Componentes Principales) para explorar la variabilidad de los datos
pca_result <- prcomp(t(assays(se)$counts), scale = TRUE)
summary(pca_result)  # Ver el resumen de las componentes principales

# Graficar los primeros dos componentes principales (PC1 vs PC2)
pca_scores <- pca_result$x
pca_scores_df <- data.frame(pca_scores)

ggplot(pca_scores_df, aes(x = PC1, y = PC2)) +
  geom_point() +
  labs(title = "PCA: PC1 vs PC2", x = "PC1", y = "PC2") +
  theme_minimal()

# Guardar el gráfico PCA como archivo PNG
ggsave("C:/Users/merma/OneDrive/Escritorio/pca_plot.png")

# Extraer la varianza explicada por cada componente principal
varianza_explicada <- pca_result$sdev^2 / sum(pca_result$sdev^2)
varianza_acumulada <- cumsum(varianza_explicada)

# Crear un data frame con la varianza explicada y acumulada
varianza_df <- data.frame(PC = paste0("PC", 1:length(varianza_explicada)),
                          Varianza_Explicada = varianza_explicada,
                          Varianza_Acumulada = varianza_acumulada)

# Graficar varianza explicada y acumulada
ggplot(varianza_df, aes(x = PC)) +
  geom_bar(aes(y = Varianza_Explicada), stat = "identity", fill = "blue", alpha = 0.6) +
  geom_line(aes(y = Varianza_Acumulada * max(varianza_explicada), group = 1), color = "red", linewidth = 1) + 
  geom_point(aes(y = Varianza_Acumulada * max(varianza_explicada), group = 1), color = "red") + 
  labs(title = "Varianza Explicada y Acumulada por los Componentes Principales",
       x = "Componente Principal",
       y = "Proporción de Varianza / Acumulada") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_y_continuous(sec.axis = sec_axis(~./max(varianza_explicada), name = "Proporción Acumulada")) +
  theme_minimal()

# Guardar el gráfico de varianza explicada
ggsave("C:/Users/merma/OneDrive/Escritorio/varianza_explicada.png", width = 10, height = 6, dpi = 300)

# Exportar los resultados del PCA a un archivo CSV
write.csv(pca_scores_df, file = "C:/Users/merma/OneDrive/Escritorio/pca_scores.csv")

#Puedo mirar rutas metabolicas

# Instalar paquetes para KEGG
BiocManager::install("KEGGREST")

install.packages("igraph")  # Instalar el paquete
library(igraph)  # Cargar el paquete


# Definir los umbrales de correlación
threshold <- 0.7
cor_matrix_filtered <- cor_matrix
cor_matrix_filtered[abs(cor_matrix_filtered) < threshold] <- 0

# Crear un grafico de la matriz de correlación
g <- graph_from_adjacency_matrix(cor_matrix_filtered, weighted = TRUE, mode = "undirected")
plot(g, vertex.label = rownames(cor_matrix), vertex.size = 5, edge.width = E(g)$weight * 5)

png("C:/Users/merma/OneDrive/Escritorio/grafico_correlacion.png", width = 800, height = 800)
plot(g, vertex.label = rownames(cor_matrix_filtered), vertex.size = 5, edge.width = E(g)$weight * 5)
dev.off() 

```

![Heatmap](C:/Users/merma/OneDrive/Escritorio/heatmap.png)
![Varianza explicada](C:/Users/merma/OneDrive/Escritorio/varianza_explicada.png)
![Varianza explicada](C:/Users/merma/OneDrive/Escritorio/grafico_correlacion.png)

Promedio de concentraciones de metabolitos (ordenados de mayor a menor): Aqui observamos la Creatinina y el citrato con valores altos, como tambien el hipurato. 

- **Creatinine**: 9521.7754
- **Hippurate**: 2614.1479
- **Citrate**: 2423.4689
- **Glycine**: 950.9063
- **Trimethylamine N-oxide**: 700.7406
- **Glucose**: 657.2894
- **Taurine**: 571.7576
- **Dimethylamine**: 393.1835
- **pi-Methylhistidine**: 391.5184
- **Glutamine**: 337.0968


